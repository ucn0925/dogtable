<h1><%= @shop.name %></h1>
<p>♡ <%= @shop.shop_favorites.count %> 件のお気に入り</p>
<p>住所：<%= @shop.address %></p>
<p>ジャンル：<%= @shop.genre.name %></p>

<h3>店舗情報</h3>
<p>営業時間：<%= @shop.opening_hours.presence || "未登録" %></p>
<p>定休日：<%= @shop.closed_days.presence || "未登録" %></p>
<p>駐車場：<%= @shop.parking ? "あり" : "なし" %></p>

<h3>犬連れ情報</h3>
<ul style="list-style: none; padding-left: 0;">
  <li>店内同伴OK：<%= @shop.inside_ok? ? "⭕️" : "❌" %></li>
  <li>テラスOK：<%= @shop.terrace_ok? ? "⭕️" : "❌" %></li>
  <li>犬用メニューあり：<%= @shop.dog_menu? ? "⭕️" : "❌" %></li>
  <li>リードフックあり：<%= @shop.lead_hook? ? "⭕️" : "❌" %></li>
<ul>


<p>
  ☆平均評価：
  <% if @average_rating.present? %>
    <% full = @average_rating.floor %>
    <% frac = @average_rating - full %>

    <% 5.times do |i| %>
      <% if i < full %>
        <span style="color: gold;">★</span>
      <% elsif i == full && frac >= 0.5 %>
        <span style="color: lightgray;">☆</span>
      <% else %>
        <span style="color: lightgray;">★</span>
      <% end %>
    <% end %>
    <%= @average_rating %>点
  <% else %>
    まだ評価がありません
  <% end %>
</p>

<% if @shop.images.attached? %>
  <h3>店舗写真</h3>
  <div style="display: flex; gap: 10px; flex-wrap: wrap;">
    <% @shop.images.each do |image| %>
      <%= image_tag image, style: "width: 200px; border-radius: 8px;" %>
    <% end %>
  </div>
<% end %>

<% if user_signed_in? %>
  <% if current_user.shop_favorites.exists?(shop_id: @shop.id) %>
    <%= link_to shop_shop_favorite_path(@shop), 
        data: { turbo_method: :delete, turbo_confirm: "お気に入りを解除しますか？" },
        class: "btn btn-outline-danger" do %>
      ♥ お気に入り解除
    <% end %>
  <% else %>
    <%= link_to shop_shop_favorite_path(@shop), 
        data: { turbo_method: :post },
        class: "btn btn-outline-primary" do %>
      ♡ お気に入り登録
    <% end %>
  <% end %>  
<% end %>

<%= link_to "編集する", edit_shop_path %>
<%= link_to "一覧に戻る", shops_path(@shop) %>
<%= link_to "削除する", shop_path(@shop), data: { turbo_method: :delete, turbo_confirm: "本当に削除しますか？"} %>

<hr>

<h3 style="margin-top: 30px;">口コミ一覧</h3>

<% if @shop.posts.any? %>
  <% @shop.posts.includes(:user).order(created_at: :desc).each do |post| %>
    <div style="border-bottom: 1px solid #ddd; padding: 16px 0;">
      <!-- ユーザー名と投稿日 -->
      <div style="display: flex; align-items: center; justify-content: space-between;">
        <div>
          <strong style="font-size: 1.1em;">
            <% if post.user.present? %>
              <%= link_to post.user.name, user_path(post.user), style: "color: #0073bb; text-decoration: none;" %>
            <% else %>
              退会ユーザー
            <% end %>
          </strong>
          <span style="color: #888; font-size: 0.9em; margin-left: 6px;">
            <%= post.created_at.strftime("%Y/%m/%d %H:%M") %>
          </span>
        </div>

        <% if post.user == current_user %>
          <div style="font-size: 0.9em;">
            <%= link_to "編集", edit_shop_post_path(@shop, post),
                  style: "margin-right: 8px; color: #0073bb;" %>
            <%= link_to "削除", shop_post_path(@shop, post),
                  data: { turbo_method: :delete, turbo_confirm: "この投稿を削除しますか？" },
                  style: "color: #bb0000;" %>
          </div>
        <% end %>
      </div>

      <!-- 口コミ詳細ページへのリンク -->
      <div style="margin-top: 6px;">
        <%= link_to "口コミの詳細を見る →", shop_post_path(@shop, post), style: "color: #0073bb;" %>
      </div>

      <!-- 評価表示 -->
      <div style="margin: 6px 0; font-size: 0.95em;">
        総合評価：
        <% (1..5).each do |i| %>
          <span style="color: <%= i <= (post.rating_overall || 0) ? 'gold' : '#ccc' %>;">★</span>
        <% end %>
        料理：
        <% (1..5).each do |i| %>
          <span style="color: <%= i <= (post.rating_food || 0) ? 'gold' : '#ccc' %>;">★</span>
        <% end %>
        犬連れやすさ：
        <% (1..5).each do |i| %>
          <span style="color: <%= i <= (post.rating_dog_friendliness || 0) ? 'gold' : '#ccc' %>;">★</span>
        <% end %>
      </div>

      <% if post.dog_size.present? %>
        <p style="margin: 4px 0;">🐶 一緒に行った犬のサイズ：
          <%=
            case post.dog_size
            when "small" then "小型犬"
            when "medium" then "中型犬"
            when "large" then "大型犬"
            else "未選択"
            end
          %>
        </p>
      <% end %>

      <!-- コメント内容 -->
      <div style="margin-top: 8px; line-height: 1.6;">

        <% if post.images.attached? %>
          <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 8px;">
            <% post.images.each do |image| %>
              <%= image_tag image.variant(resize_to_limit: [250, 250]), style: "border-radius: 6px;" %>
            <% end %>
          </div>
        <% end %>

        <%= simple_format(h(post.content)) %>
      </div>

      <% if post.visited_on.present? %>
        <p>訪問日：<%= post.visited_on.strftime("%Y/%m/%d") %></p>
      <% end %>

    </div>
  <% end %>
<% else %>
  <p>まだ口コミはありません。</p>
<% end %>

<h2>新規投稿</h2>

<% if user_signed_in? %>
  <%= render "posts/form", post: @shop.posts.build, shop: @shop %>

<% else %>
  <p>コメントを投稿するにはログインが必要です。</p>
<% end %>

<hr>
